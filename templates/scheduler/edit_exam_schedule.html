{% extends 'home/base.html' %}
{% load static %}

{% block title %}Edit Exam Schedule{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-edit"></i> Edit Exam Schedule
                    </h4>
                </div>
                <div class="card-body">
                    {% if conflict_details %}
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-triangle"></i> Conflicts Detected</h5>
                            <p>The following conflicts prevent this exam schedule from being saved:</p>
                            <div class="mt-3">
                                {% for conflict in conflict_details %}
                                    <div class="conflict-item mb-3 p-3 border border-danger rounded">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge bg-danger me-2">
                                                {% if conflict.type == 'course' %}
                                                    <i class="fas fa-book"></i> Course Conflict
                                                {% elif conflict.type == 'room' %}
                                                    <i class="fas fa-door-open"></i> Room Conflict
                                                {% elif conflict.type == 'proctor' %}
                                                    <i class="fas fa-user-tie"></i> Proctor Conflict
                                                {% endif %}
                                            </span>
                                            <strong>{{ conflict.message }}</strong>
                                        </div>
                                        <div class="conflict-details text-muted">
                                            <small>{{ conflict.details }}</small>
                                        </div>
                                        {% if conflict.conflict_schedule %}
                                            <div class="mt-2">
                                                <a href="{% url 'scheduler:edit_exam_schedule' conflict.conflict_schedule.id %}" 
                                                   class="btn btn-outline-danger btn-sm">
                                                    <i class="fas fa-edit"></i> Edit Conflicting Schedule
                                                </a>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Exam Period Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-calendar-alt"></i> Official Exam Period
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Exam Period:</strong> {{ first_exam_date.date|date:'M d, Y' }} - {{ last_exam_date.date|date:'M d, Y' }}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Available Dates:</strong> {{ exam_dates|length }} exam days
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i> 
                                            Exams can only be scheduled during the official exam period. 
                                            All dates outside this period are not available.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Availability Analysis and Guidance Section -->
                    {% if availability_analysis or room_availability or proctor_availability or alternative_suggestions %}
                        <div class="row mb-4">
                            <!-- Current Exam Analysis -->
                            {% if availability_analysis %}
                                <div class="col-md-6 mb-3">
                                    <div class="card border-info">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-chart-line"></i> Current Exam Analysis
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted">Student Enrollment</small>
                                                    <div class="h5 text-primary">{{ availability_analysis.student_count }}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Available Rooms</small>
                                                    <div class="h5 text-success">{{ availability_analysis.available_rooms.count }}</div>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-6">
                                                    <small class="text-muted">Available Proctors</small>
                                                    <div class="h5 text-info">{{ availability_analysis.available_proctors.count }}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Total Capacity</small>
                                                    <div class="h5 text-warning">{{ availability_analysis.total_room_capacity }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Room Availability -->
                            {% if room_availability %}
                                <div class="col-md-6 mb-3">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-door-open"></i> Room Availability
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted">Available</small>
                                                    <div class="h5 text-success">{{ room_availability.available_rooms.count }}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Booked</small>
                                                    <div class="h5 text-danger">{{ room_availability.booked_rooms.count }}</div>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">Total Capacity Available</small>
                                                <div class="h6 text-primary">{{ room_availability.total_capacity }} students</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Proctor Availability -->
                            {% if proctor_availability %}
                                <div class="col-md-6 mb-3">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">
                                                <i class="fas fa-user-tie"></i> Proctor Availability
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted">Available</small>
                                                    <div class="h5 text-success">{{ proctor_availability.available_count }}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Total Proctors</small>
                                                    <div class="h5 text-info">{{ proctor_availability.total_proctors }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Alternative Suggestions -->
                            {% if alternative_suggestions %}
                                <div class="col-12 mb-3">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-lightbulb"></i> Alternative Time Slots
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="text-muted mb-3">Consider these alternative dates and times for better availability:</p>
                                            <div class="row">
                                                {% for alt in alternative_suggestions|slice:":6" %}
                                                    <div class="col-md-4 mb-2">
                                                        <div class="card border-light">
                                                            <div class="card-body p-2">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <div>
                                                                        <small class="text-muted">{{ alt.date|date:"M d" }}</small>
                                                                        <div class="fw-bold">{{ alt.time_slot.start_time|time:"H:i" }} - {{ alt.time_slot.end_time|time:"H:i" }}</div>
                                                                    </div>
                                                                    <div class="text-end">
                                                                        <small class="text-success">{{ alt.available_rooms }} rooms</small>
                                                                        <div class="small text-info">{{ alt.available_proctors }} proctors</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <form method="post" data-conflict-types="{% if conflict_details %}{% for conflict in conflict_details %}{{ conflict.type }}{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="course" class="form-label">
                                <i class="fas fa-book"></i> Course
                                <small class="text-muted">({{ courses|length }} courses available)</small>
                            </label>
                            <select class="form-select" id="course" name="course" required>
                                <option value="">Select Course</option>
                                {% for course in courses %}
                                    <option value="{{ course.id }}" 
                                            {% if form_data.course_id == course.id|stringformat:"s" or exam_schedule.course.id == course.id %}selected{% endif %}
                                            data-student-count="{{ course.student_count }}">
                                        {{ course.code }} - {{ course.name }} ({{ course.student_count }} students)
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info"></i> 
                                Select the course for this exam. Student count is shown in parentheses.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="exam_date" class="form-label">
                                <i class="fas fa-calendar"></i> Exam Date
                                <small class="text-muted">(Official Exam Period Only)</small>
                            </label>
                            <select class="form-select" id="exam_date" name="exam_date" required>
                                <option value="">Select Exam Date</option>
                                {% for exam_date in exam_dates %}
                                    <option value="{{ exam_date.date|date:'Y-m-d' }}" 
                                            {% if form_data.exam_date == exam_date.date|date:'Y-m-d' or exam_schedule.date == exam_date.date %}selected{% endif %}>
                                        {{ exam_date.date|date:'M d, Y' }} ({{ exam_date.day_name }})
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info"></i> 
                                <strong>Exam Period:</strong> {{ first_exam_date.date|date:'M d' }} - {{ last_exam_date.date|date:'M d, Y' }}. 
                                Only official exam dates are available.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="time_slot" class="form-label">
                                <i class="fas fa-clock"></i> Time Slot
                                <small class="text-muted">({{ time_slots|length }} slots available)</small>
                            </label>
                            <select class="form-select" id="time_slot" name="time_slot" required>
                                <option value="">Select Time Slot</option>
                                {% for slot in time_slots %}
                                    <option value="{{ slot.id }}" 
                                            {% if form_data.time_slot_id == slot.id|stringformat:"s" or exam_schedule.time_slot.id == slot.id %}selected{% endif %}>
                                        {{ slot.start_time|time:"H:i" }} - {{ slot.end_time|time:"H:i" }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info"></i> 
                                Choose an exam time slot. Consider alternative suggestions above for better availability.
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Exam Schedule
                            </button>
                            <a href="{% url 'portal:exam_timetable_grid' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .conflict-item {
        background-color: #fff5f5;
    }
    
    .conflict-details {
        font-size: 0.9em;
    }
    
    .badge {
        font-size: 0.8em;
    }
    
    .form-select:focus,
    .form-control:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    
    .conflict-highlight {
        border-color: #dc3545 !important;
        background-color: #fff5f5 !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const conflictTypes = form.getAttribute('data-conflict-types');
        const courseSelect = document.getElementById('course');
        const dateInput = document.getElementById('exam_date');
        const timeSelect = document.getElementById('time_slot');
        
        // Highlight conflicting fields
        if (conflictTypes) {
            const types = conflictTypes.split(',');
            
            types.forEach(function(type) {
                if (type === 'course') {
                    courseSelect.classList.add('conflict-highlight');
                } else if (type === 'room') {
                    // Room conflicts are handled at the exam level, not individual field
                } else if (type === 'proctor') {
                    // Proctor conflicts are handled at the exam level, not individual field
                }
            });
        }
        
        // Add real-time feedback for course selection
        courseSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const studentCount = selectedOption.getAttribute('data-student-count');
            
            // Remove previous feedback
            const existingFeedback = document.querySelector('.course-feedback');
            if (existingFeedback) {
                existingFeedback.remove();
            }
            
            if (studentCount && studentCount !== '0') {
                const feedback = document.createElement('div');
                feedback.className = 'course-feedback alert alert-info mt-2';
                feedback.innerHTML = `
                    <i class="fas fa-users"></i> 
                    <strong>${studentCount} students</strong> are enrolled in this course. 
                    Make sure you have adequate room capacity and proctors.
                `;
                courseSelect.parentNode.appendChild(feedback);
            }
        });
        
        // Add date validation feedback
        dateInput.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const dateText = selectedOption.textContent;
            
            // Remove previous feedback
            const existingFeedback = document.querySelector('.date-feedback');
            if (existingFeedback) {
                existingFeedback.remove();
            }
            
            if (dateText && dateText !== 'Select Exam Date') {
                const feedback = document.createElement('div');
                feedback.className = 'date-feedback alert alert-info mt-2';
                feedback.innerHTML = `
                    <i class="fas fa-calendar-check"></i> 
                    <strong>${dateText}</strong> selected. 
                    This is an official exam date within the exam period.
                `;
                dateInput.parentNode.appendChild(feedback);
            }
        });
        
        // Add time slot selection feedback
        timeSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const timeText = selectedOption.textContent;
            
            // Remove previous feedback
            const existingFeedback = document.querySelector('.time-feedback');
            if (existingFeedback) {
                existingFeedback.remove();
            }
            
            if (timeText && timeText !== 'Select Time Slot') {
                const feedback = document.createElement('div');
                feedback.className = 'time-feedback alert alert-info mt-2';
                feedback.innerHTML = `
                    <i class="fas fa-clock"></i> 
                    <strong>${timeText}</strong> selected. 
                    Check the availability analysis above for room and proctor availability.
                `;
                timeSelect.parentNode.appendChild(feedback);
            }
        });
        
        // Add loading indicator to submit button
        form.addEventListener('submit', function() {
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            submitBtn.disabled = true;
        });
        
        // Trigger initial feedback if course is pre-selected
        if (courseSelect.value) {
            courseSelect.dispatchEvent(new Event('change'));
        }
    });
</script>
{% endblock %}
